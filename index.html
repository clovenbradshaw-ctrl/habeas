<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/habeas/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Habeas</title>
    <script type="module" crossorigin src="/habeas/assets/index-DNJ52zVR.js"></script>
    <link rel="stylesheet" crossorigin href="/habeas/assets/index-CRhTV_SU.css">
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
/* ═══ CONSTANTS ═══ */
const STAGES=['Intake','Drafting','Attorney Review','Ready to File','Filed','Awaiting Response','Reply Filed','Order Received','Bond Hearing','Resolved'];
const SC={'Intake':'#6366f1','Drafting':'#8b5cf6','Attorney Review':'#a855f7','Ready to File':'#d946ef','Filed':'#1e40af','Awaiting Response':'#c2410c','Reply Filed':'#f97316','Order Received':'#eab308','Bond Hearing':'#15803d','Resolved':'#78716c'};
const NEXT_ACTION={'Intake':'Complete client information and assign attorney','Drafting':'Draft petition from template and fill all variables','Attorney Review':'Review petition for accuracy and completeness','Ready to File':'File petition with the court','Filed':'Monitor for court response','Awaiting Response':'Prepare reply brief when response received','Reply Filed':'Await court order','Order Received':'Prepare for bond hearing','Bond Hearing':'Attend hearing and update outcome','Resolved':'Case closed'};

/* ═══ STATE ═══ */
const S={view:'mycases',user:null,role:'partner',token:'',matters:[],matterId:null,md:null,tpl:null,loading:false,attFilter:'',wizStep:0};

/* ═══ CONFIG ═══ */
const MATRIX_BASE='https://app.aminoimmigration.com';
const ADMIN_ROOM_ALIAS='#habeas-admins:app.aminoimmigration.com';
const DATA_ROOM_ALIAS='#habeas-data:app.aminoimmigration.com';
let DATA_ROOM_ID=null;
let ADMIN_ROOM_ID=null;
const MX_TYPES={facilities:'com.habeas.facility',wardens:'com.habeas.warden',attorneys:'com.habeas.attorney',fieldOffices:'com.habeas.field_office',courts:'com.habeas.court',officials:'com.habeas.official',matters:'com.habeas.matter'};
function cfgShow(){document.getElementById('cfgModal').classList.remove('hide');const dr=document.getElementById('cfgDataRoom');if(dr)dr.value=DATA_ROOM_ID||'Not connected';const ar=document.getElementById('cfgAdminRoom');if(ar)ar.value=ADMIN_ROOM_ID||'Not connected'}
function cfgHide(){document.getElementById('cfgModal').classList.add('hide')}

/* ═══ MATRIX ROOM DATA CLIENT ═══ */
function mxH(){return{'Authorization':'Bearer '+S.token,'Content-Type':'application/json'}}
async function mxGetAllState(roomId){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/state',{headers:mxH()});if(!r.ok)throw new Error('State '+r.status);return r.json()}
async function mxGetState(roomId,evType,stateKey){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/state/'+encodeURIComponent(evType)+'/'+encodeURIComponent(stateKey||''),{headers:mxH()});if(!r.ok)throw new Error('State '+r.status);return r.json()}
async function mxPutState(roomId,evType,stateKey,content){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/state/'+encodeURIComponent(evType)+'/'+encodeURIComponent(stateKey||''),{method:'PUT',headers:mxH(),body:JSON.stringify(content)});if(!r.ok)throw new Error('State '+r.status);return r.json()}
async function mxResolveAlias(alias){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/directory/room/'+encodeURIComponent(alias),{headers:mxH()});if(!r.ok)return null;const d=await r.json();return d.room_id}
async function mxJoinRoom(roomIdOrAlias){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/join/'+encodeURIComponent(roomIdOrAlias),{method:'POST',headers:mxH(),body:'{}'});if(!r.ok)throw new Error('Join '+r.status);return r.json()}
async function mxCreateRoom(aliasLocal,name){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/createRoom',{method:'POST',headers:mxH(),body:JSON.stringify({room_alias_name:aliasLocal,name:name,visibility:'private',preset:'public_chat'})});if(!r.ok)throw new Error('Create room '+r.status);return r.json()}
async function mxInvite(roomId,userId){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/invite',{method:'POST',headers:mxH(),body:JSON.stringify({user_id:userId})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||'Invite '+r.status)}}
async function mxKick(roomId,userId){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/kick',{method:'POST',headers:mxH(),body:JSON.stringify({user_id:userId})});if(!r.ok)throw new Error('Kick '+r.status)}
async function mxJoinedMembers(roomId){const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/rooms/'+encodeURIComponent(roomId)+'/joined_members',{headers:mxH()});if(!r.ok)throw new Error('Members '+r.status);return r.json()}

/* ═══ MATRIX SYNC ═══ */
let syncToken=null;let syncRunning=false;
async function startSync(){if(syncRunning||!DATA_ROOM_ID)return;syncRunning=true;doSync()}
async function doSync(){if(!syncRunning)return;const qs=syncToken?'&since='+syncToken:'&full_state=false';try{const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/sync?timeout=30000&filter='+encodeURIComponent(JSON.stringify({room:{state:{rooms:[DATA_ROOM_ID]},timeline:{rooms:[DATA_ROOM_ID],limit:50}}}))+ qs,{headers:mxH()});if(!r.ok){setTimeout(doSync,5000);return}const d=await r.json();syncToken=d.next_batch;const room=d.rooms?.join?.[DATA_ROOM_ID];if(room){const stateEvts=[...(room.state?.events||[]),...(room.timeline?.events||[]).filter(e=>e.state_key!==undefined)];if(stateEvts.length>0){applySyncEvents(stateEvts)}}setTimeout(doSync,100)}catch(e){console.warn('Sync error:',e);setTimeout(doSync,5000)}}
function applySyncEvents(events){const typeToTab={'com.habeas.facility':'facilities','com.habeas.warden':'wardens','com.habeas.attorney':'attorneys','com.habeas.field_office':'fieldOffices','com.habeas.court':'courts','com.habeas.official':'officials'};let changed=false;events.forEach(ev=>{const tab=typeToTab[ev.type];if(tab){const idx=REF[tab].findIndex(r=>r.id===ev.state_key);if(ev.content._deleted||Object.keys(ev.content).length===0){if(idx>=0){REF[tab].splice(idx,1);changed=true}}else{if(idx>=0){REF[tab][idx]={...ev.content,id:ev.state_key}}else{REF[tab].push({...ev.content,id:ev.state_key})}changed=true}}else if(ev.type==='com.habeas.matter'){const idx=S.matters.findIndex(m=>m.id===ev.state_key);const mapped=mapMatter({...ev.content,id:ev.state_key});if(ev.content._deleted||Object.keys(ev.content).length===0){if(idx>=0){S.matters.splice(idx,1);changed=true}}else{if(idx>=0){S.matters[idx]=mapped}else{S.matters.push(mapped)}changed=true}}});if(changed){saveRef();draw()}}
function stopSync(){syncRunning=false}
async function ensureDataRoom(){if(DATA_ROOM_ID)return true;try{DATA_ROOM_ID=await mxResolveAlias(DATA_ROOM_ALIAS);if(DATA_ROOM_ID){try{await mxJoinRoom(DATA_ROOM_ID)}catch(e){console.warn('Data room join:',e)}return true}}catch(e){}try{const res=await mxCreateRoom('habeas-data','Habeas Shared Data');DATA_ROOM_ID=res.room_id;return true}catch(e){console.warn('Could not create data room:',e)}return false}

/* ═══ AUTH ═══ */
const SK='habeas_session';
function getSession(){return JSON.parse(localStorage.getItem(SK)||'null')}
function setSession(s){localStorage.setItem(SK,JSON.stringify(s))}
function clearSession(){localStorage.removeItem(SK)}
function extractEmail(userId){return userId.replace(/^@/,'').split(':')[0]}
async function determineRole(token,userId){try{const aliasUrl=MATRIX_BASE+'/_matrix/client/v3/directory/room/'+encodeURIComponent(ADMIN_ROOM_ALIAS);const ar=await fetch(aliasUrl,{headers:{'Authorization':'Bearer '+token}});if(!ar.ok)return'partner';const{room_id}=await ar.json();const joinedUrl=MATRIX_BASE+'/_matrix/client/v3/joined_rooms';const jr=await fetch(joinedUrl,{headers:{'Authorization':'Bearer '+token}});if(!jr.ok)return'partner';const{joined_rooms}=await jr.json();return joined_rooms.includes(room_id)?'admin':'partner'}catch(e){console.warn('Role check failed:',e);return'partner'}}
async function matrixLogin(){const user=(document.getElementById('loginUser').value||'').trim();const pass=(document.getElementById('loginPass').value||'').trim();if(!user||!pass){document.getElementById('loginErr').textContent='Enter username and password.';return}const btn=document.getElementById('loginBtn');btn.disabled=true;btn.textContent='Signing in\u2026';document.getElementById('loginErr').textContent='';try{const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'m.login.password',identifier:{type:'m.id.user',user:user},password:pass,initial_device_display_name:'Habeas Web'})});if(!r.ok){const err=await r.json().catch(()=>({}));if(r.status===403||r.status===401){document.getElementById('loginErr').textContent='Invalid username or password.'}else{document.getElementById('loginErr').textContent=err.error||'Login failed.'}btn.disabled=false;btn.textContent='Sign in';return}const data=await r.json();let displayName=user;try{const pUrl=MATRIX_BASE+'/_matrix/client/v3/profile/'+encodeURIComponent(data.user_id)+'/displayname';const pr=await fetch(pUrl,{headers:{'Authorization':'Bearer '+data.access_token}});if(pr.ok){const pd=await pr.json();if(pd.displayname)displayName=pd.displayname}}catch(e){}const role=await determineRole(data.access_token,data.user_id);const session={userId:data.user_id,matrixToken:data.access_token,deviceId:data.device_id,name:displayName,email:extractEmail(data.user_id),role:role,ts:Date.now()};setSession(session);enterApp(session)}catch(e){document.getElementById('loginErr').textContent='Connection failed. Try again.'}btn.disabled=false;btn.textContent='Sign in'}
async function validateSession(session){if(!session||!session.matrixToken)return false;try{const r=await fetch(MATRIX_BASE+'/_matrix/client/v3/account/whoami',{headers:{'Authorization':'Bearer '+session.matrixToken}});if(r.ok){const data=await r.json();return data.user_id===session.userId}return false}catch(e){return session.ts&&(Date.now()-session.ts<7*24*60*60*1000)}}
async function logout(){const session=getSession();if(session&&session.matrixToken){try{await fetch(MATRIX_BASE+'/_matrix/client/v3/logout',{method:'POST',headers:{'Authorization':'Bearer '+session.matrixToken}})}catch(e){}}clearSession();location.reload()}
async function enterApp(session){S.user={email:session.email||extractEmail(session.userId),name:session.name,userId:session.userId};S.role=session.role;S.token=session.matrixToken;document.getElementById('loginScreen').classList.add('hide');document.getElementById('shell').classList.add('on');S.view=S.role==='admin'?'dashboard':'mycases';try{ADMIN_ROOM_ID=await mxResolveAlias(ADMIN_ROOM_ALIAS)}catch(e){}await ensureDataRoom();draw();loadAllData();if(S.role==='admin')loadTeamMembers()}

/* ═══ MOCK DATA ═══ */
const MOCK_MATTERS=[{id:'mock_rivera_001',petitionerName:'Juan Jose Rivera',name:'Rivera',stage:'Bond Hearing',circuit:'4th Circuit',facility:'Farmville Detention Center',facilityLocation:'Farmville, Virginia',attorney:'Katherine Soltis',daysInStage:3,filingDate:'October 16, 2025',caseNumber:'1:25-cv-1793',bondGranted:'Granted',daysToFiling:14,variables:{PETITIONER_NAME:'Juan Jose Rivera',PETITIONER_COUNTRY:'El Salvador',ENTRY_DATE:'October 2005',YEARS_RESIDENCE:'twenty',APPREHENSION_LOCATION:'Washington, D.C.',APPREHENSION_DATE:'October 2, 2025',CRIMINAL_HISTORY:'has never been arrested or charged with any crime',COMMUNITY_TIES:'Petitioner has resided in the Washington, D.C. metropolitan area for approximately twenty years. He has established deep roots in his community through consistent employment and close family relationships.',DETENTION_FACILITY:'Farmville Detention Center',FACILITY_LOCATION:'Farmville, Virginia',WARDEN_NAME:'Jeff Crawford',FOD_NAME:'Russell Hott',FIELD_OFFICE:'Washington Field Office',ICE_DIRECTOR:'Todd M. Lyons',DHS_SECRETARY:'Kristi Noem',AG_NAME:'Pamela Bondi',DISTRICT_FULL:'Eastern District of Virginia',DIVISION:'Alexandria Division',COURT_LOCATION:'Alexandria, Virginia',CASE_NUMBER:'1:25-cv-1793',JUDGE_CODE:'PTG/WBP',FILING_DATE:'October 16, 2025',ATTORNEY_1_NAME:'Katherine Soltis',ATTORNEY_1_BAR:'VA Bar No. 89590',ATTORNEY_1_FIRM:'Taylor Diaz & Soltis, PLLC',ATTORNEY_1_ADDR:'200 Little Falls St Suite 207, Falls Church, VA 22046',ATTORNEY_1_PHONE:'571-351-2227',ATTORNEY_1_EMAIL:'katie@tdsimmigrationlaw.com',ATTORNEY_2_NAME:'Sarnata Reynolds',ATTORNEY_2_BAR:'CA Bar No. 203444',ATTORNEY_2_FIRM:'Ceartas Solutions',ATTORNEY_2_ADDR:'6930 Carroll Ave Suite 500, Takoma Park, MD 20912',ATTORNEY_2_PHONE:'301-531-5870',ATTORNEY_2_EMAIL:'sarnata@ceartassolutions.com'}}];

/* ═══ LOAD DATA ═══ */
const TPL_KEYS=['PETITIONER_NAME','PETITIONER_COUNTRY','ENTRY_DATE','YEARS_RESIDENCE','APPREHENSION_LOCATION','APPREHENSION_DATE','CRIMINAL_HISTORY','COMMUNITY_TIES','DETENTION_FACILITY','FACILITY_LOCATION','WARDEN_NAME','FOD_NAME','FIELD_OFFICE','ICE_DIRECTOR','DHS_SECRETARY','AG_NAME','DISTRICT_FULL','DIVISION','COURT_LOCATION','CASE_NUMBER','JUDGE_CODE','FILING_DATE','ATTORNEY_1_NAME','ATTORNEY_1_BAR','ATTORNEY_1_FIRM','ATTORNEY_1_ADDR','ATTORNEY_1_PHONE','ATTORNEY_1_EMAIL','ATTORNEY_2_NAME','ATTORNEY_2_BAR','ATTORNEY_2_FIRM','ATTORNEY_2_ADDR','ATTORNEY_2_PHONE','ATTORNEY_2_EMAIL'];
function mapMatter(e){const v={};TPL_KEYS.forEach(k=>{if(e[k])v[k]=e[k]});const sc=e.stage_changed_at?new Date(e.stage_changed_at):new Date();const dis=Math.max(0,Math.floor((Date.now()-sc.getTime())/86400000));return{id:e.id,petitionerName:e.petitioner_name||v.PETITIONER_NAME||'',name:e.petitioner_name||v.PETITIONER_NAME||'',stage:e.stage||'Intake',circuit:e.circuit||'',facility:e.facility||v.DETENTION_FACILITY||'',facilityLocation:e.facility_location||v.FACILITY_LOCATION||'',attorney:e.attorney||v.ATTORNEY_1_NAME||'',daysInStage:dis,filingDate:e.filing_date||v.FILING_DATE||'',caseNumber:e.case_number||v.CASE_NUMBER||'',bondGranted:e.bond_granted||'',daysToFiling:e.days_to_filing||0,variables:v}}
async function loadAllData(){if(!DATA_ROOM_ID){S.matters=[...MOCK_MATTERS];draw();return}S.loading=true;draw();try{const state=await mxGetAllState(DATA_ROOM_ID);const typeToTab={'com.habeas.facility':'facilities','com.habeas.warden':'wardens','com.habeas.attorney':'attorneys','com.habeas.field_office':'fieldOffices','com.habeas.court':'courts','com.habeas.official':'officials'};REF.facilities=[];REF.wardens=[];REF.attorneys=[];REF.fieldOffices=[];REF.courts=[];REF.officials=[];S.matters=[];state.forEach(ev=>{if(!ev.content||ev.content._deleted)return;if(Object.keys(ev.content).length===0)return;const tab=typeToTab[ev.type];if(tab){REF[tab].push({...ev.content,id:ev.state_key})}else if(ev.type==='com.habeas.matter'){S.matters.push(mapMatter({...ev.content,id:ev.state_key}))}});saveRef()}catch(e){console.warn('Matrix load failed, using fallback:',e.message);S.matters=[]}if(!S.matters.length)S.matters=[...MOCK_MATTERS];seedRef();S.loading=false;draw();startSync()}
async function loadRefData(){await loadAllData()}
async function loadMatters(){await loadAllData()}
function resolveTemplate(matter,apiTpl){if(apiTpl&&apiTpl.html)return apiTpl;return TEMPLATES['default']}
async function loadMatter(id){S.loading=true;S.matterId=id;draw();const mock=MOCK_MATTERS.find(m=>m.id===id);if(mock){S.md=mock;S.tpl=resolveTemplate(mock,null);S.loading=false;draw();return}const cached=S.matters.find(m=>m.id===id);if(cached){S.md=cached;S.tpl=resolveTemplate(S.md,null);S.loading=false;draw();return}try{if(DATA_ROOM_ID){const e=await mxGetState(DATA_ROOM_ID,'com.habeas.matter',id);S.md=mapMatter({...e,id});S.tpl=resolveTemplate(S.md,null)}}catch(e){console.error(e)}S.loading=false;draw()}

